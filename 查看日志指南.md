# 查看日志指南

## Windows 开发环境

### 方法1：直接运行查看控制台日志

如果你使用 `python run.py` 或 `uvicorn` 直接运行，日志会直接输出到控制台：

```bash
# 在项目根目录运行
python run.py
```

日志会实时显示在控制台中，包括：
- 审批提醒消息发送日志
- 审批结果通知发送日志
- 微信API调用日志
- 错误信息

### 方法2：将日志输出到文件

```bash
# 将日志保存到文件
python run.py > logs/app.log 2>&1

# 或者使用PowerShell
python run.py | Tee-Object -FilePath logs/app.log
```

然后可以用文本编辑器打开 `logs/app.log` 查看，或者使用：

```powershell
# 实时查看日志文件（需要安装Git Bash或使用WSL）
Get-Content logs/app.log -Wait -Tail 50
```

### 方法3：使用IDE查看

如果你使用VS Code、PyCharm等IDE运行，日志会显示在IDE的控制台/终端窗口中。

## Linux 生产环境

### 如果使用 systemd 服务

```bash
# 实时查看日志
sudo journalctl -u attendance-backend -f

# 查看最近100行
sudo journalctl -u attendance-backend -n 100

# 查看今天的日志
sudo journalctl -u attendance-backend --since today

# 查看错误日志
sudo journalctl -u attendance-backend -p err

# 查看指定时间段的日志
sudo journalctl -u attendance-backend --since "2024-01-01 00:00:00" --until "2024-01-01 23:59:59"
```

### 如果使用直接启动方式

```bash
# 查看日志文件
tail -f logs/app.log

# 查看最近100行
tail -n 100 logs/app.log

# 查看错误日志
grep -i error logs/app.log
```

## 过滤审批相关的日志

### 查看审批结果通知相关日志

```bash
# Windows PowerShell
Select-String -Path logs/app.log -Pattern "审批结果通知"

# Linux/Mac
grep "审批结果通知" logs/app.log

# 实时查看审批结果通知日志
# Windows PowerShell
Get-Content logs/app.log -Wait | Select-String "审批结果通知"

# Linux/Mac
tail -f logs/app.log | grep "审批结果通知"
```

### 查看微信消息推送相关日志

```bash
# 查看所有微信消息推送日志
grep -i "发送.*消息\|订阅消息\|wechat" logs/app.log

# 查看审批提醒消息
grep "审批提醒消息" logs/app.log

# 查看审批结果通知
grep "审批结果通知" logs/app.log

# 查看微信API错误
grep -i "errcode\|errmsg\|失败" logs/app.log
```

## 常见日志信息说明

### 成功发送审批结果通知
```
INFO: 发送审批结果通知 - 申请人: 张三, 审批事项: 普通请假, 结果: 已通过, 审批人: 李经理, 日期: 20240115
INFO: 成功发送订阅消息给用户 oxxxxxx... (模板ID: xxxxxx...)
```

### 模板ID未配置
```
WARNING: 审批结果通知模板ID未配置，跳过消息推送
```

### 用户拒绝接收消息
```
INFO: 用户 oxxxxxx... 拒绝接收订阅消息 (模板ID: xxxxxx...)
```

### 发送失败（其他错误）
```
WARNING: 发送订阅消息失败: 错误信息 (errcode: 40001, 模板ID: xxxxxx..., 用户: oxxxxxx...)
```

### 异常错误
```
ERROR: 发送订阅消息异常: 异常信息 (模板ID: xxxxxx..., 用户: oxxxxxx...)
```

## 调试技巧

### 1. 查看完整的请求和响应

在 `backend/services/wechat_message.py` 中，我已经添加了详细的日志。如果遇到问题，可以：

1. 检查日志中是否有错误信息
2. 查看 `errcode` 和 `errmsg` 了解具体错误原因
3. 确认模板ID是否正确配置
4. 确认用户的 openid 是否存在

### 2. 临时启用更详细的日志

如果需要更详细的调试信息，可以修改 `run.py`：

```python
uvicorn.run(
    "backend.main:app",
    host="0.0.0.0",
    port=8000,
    reload=True,
    log_level="debug"  # 改为 debug 级别
)
```

### 3. 测试审批结果通知

1. 进行一次审批操作（通过或拒绝）
2. 立即查看日志，搜索 "审批结果通知"
3. 检查是否有错误信息
4. 如果看到 "成功发送订阅消息"，说明推送成功
5. 如果看到错误码，根据错误码查找原因

## 常见错误码说明

- **0**: 成功
- **43101**: 用户拒绝接收消息（这是正常情况，不是错误）
- **40001**: access_token无效或过期
- **40037**: 模板ID无效
- **47003**: 参数错误（可能是字段格式不正确）

## 快速检查命令

```bash
# 检查最近的审批结果通知日志（最近20条）
# Windows PowerShell
Get-Content logs/app.log -Tail 100 | Select-String "审批结果通知"

# Linux/Mac
tail -n 100 logs/app.log | grep "审批结果通知"
```

