# 授权问题排查和修复指南

## 问题现象

从日志可以看到：
- ✅ 待审批通知发送成功（模板ID: `JzcNdxTsNr-OTqMjqzF4...`）
- ❌ 审批结果通知发送失败（模板ID: `58inG1DfC2U_9Za0Csn4...`，用户拒绝）

## 问题原因

用户只授权了待审批通知模板，拒绝了审批结果通知模板的授权。

## 排查步骤

### 1. 检查小程序中的模板ID配置

打开 `miniprogram/app.js`，检查 `subscribeTemplateIds` 配置：

```javascript
subscribeTemplateIds: [
  'JzcNdxTsNr-OTqMjqzF4xx1GRZab-lMXXq6ux-vIdxM',  // 待审批通知模板ID
  '58inG1DfC2U_9Za0Csn4xx1GRZab-lMXXq6ux-vIdxM'   // 审批结果通知模板ID
]
```

**检查要点：**
- ✅ 两个模板ID必须不同
- ✅ 模板ID必须是完整的（通常32个字符）
- ✅ 模板ID不能是占位符（如 `TODO`、`YOUR_` 等）

### 2. 检查后端配置

检查 `.env` 文件中的模板ID配置：

```bash
# 查看模板ID配置
grep WECHAT.*TEMPLATE_ID .env
```

应该看到：
```
WECHAT_APPROVAL_TEMPLATE_ID=JzcNdxTsNr-OTqMjqzF4xx1GRZab-lMXXq6ux-vIdxM
WECHAT_RESULT_TEMPLATE_ID=58inG1DfC2U_9Za0Csn4xx1GRZab-lMXXq6ux-vIdxM
```

**检查要点：**
- ✅ 两个模板ID必须不同
- ✅ 模板ID必须与小程序中的配置一致
- ✅ 模板ID没有多余的空格

### 3. 检查授权状态

在微信开发者工具的控制台中运行：

```javascript
// 获取授权状态
const app = getApp();
const status = app.getSubscribeMessageAuthStatus();
console.log('授权状态:', status);

// 检查是否全部授权
const isAll = app.isAllSubscribeMessageAuthorized();
console.log('是否全部授权:', isAll);
```

## 修复方法

### 方法1：清除授权状态并重新授权（推荐）

1. **清除授权状态**

在微信开发者工具的控制台中运行：

```javascript
// 清除授权状态
wx.removeStorageSync('subscribe_message_authorized');
wx.removeStorageSync('subscribe_message_auth_status');
console.log('授权状态已清除');
```

2. **重新登录小程序**

- 退出小程序
- 重新打开小程序
- 登录后会重新弹出授权弹窗

3. **确保两个模板都授权**

- 在授权弹窗中，确保两个模板都勾选"允许"
- 点击"允许"完成授权

### 方法2：在关键操作时重新授权

如果用户之前拒绝了授权，系统会在以下场景自动请求授权：

1. **提交申请时**
   - 提交请假/加班申请时
   - 会弹出授权弹窗
   - 确保两个模板都授权

2. **审批时**
   - 进行审批操作时
   - 会弹出授权弹窗
   - 确保两个模板都授权

### 方法3：手动触发授权

在小程序中添加一个"重新授权"按钮，让用户手动触发授权：

```javascript
// 在页面中添加重新授权按钮
reAuthorize() {
  // 清除授权状态
  wx.removeStorageSync('subscribe_message_authorized');
  wx.removeStorageSync('subscribe_message_auth_status');
  
  // 重新授权
  const app = getApp();
  app.requestSubscribeMessage([], {
    showTip: true,
    tipTitle: '重新授权',
    tipContent: '为了确保能收到所有类型的通知，请允许所有模板授权。'
  });
}
```

## 验证授权是否成功

### 1. 查看控制台日志

授权后，在控制台查看：

```javascript
// 应该看到详细的授权结果
📋 订阅消息授权详细结果: {
  总模板数: 2,
  返回结果数: 2,
  已授权: 2,
  已拒绝: 0,
  全部授权: true
}
```

### 2. 测试消息推送

1. **测试待审批通知**
   - 提交一个请假/加班申请
   - 审批人应该收到待审批通知

2. **测试审批结果通知**
   - 审批一个申请（通过或拒绝）
   - 申请人应该收到审批结果通知

### 3. 查看后端日志

```bash
# 实时查看日志
sudo journalctl -u attendance-backend -f | grep "订阅消息"

# 应该看到：
# ✅ 成功发送订阅消息给用户 ... (模板ID: ...)
# 而不是：
# ❌ 用户 ... 拒绝接收订阅消息
```

## 常见问题

### Q1: 为什么用户会拒绝授权？

**A:** 可能的原因：
1. 用户误操作，点击了"拒绝"
2. 授权弹窗显示不清楚，用户不知道需要授权两个模板
3. 用户之前授权过，但只授权了一个模板

### Q2: 如何确保用户授权两个模板？

**A:** 
1. 在授权说明中明确告知需要授权两个模板
2. 授权后检查结果，如果部分授权，提示用户重新授权
3. 在关键操作前自动请求授权

### Q3: 授权会过期吗？

**A:** 会的。微信订阅消息授权有时效性：
- 用户授权后，授权状态会保存一段时间
- 过期后需要重新授权
- 系统会在关键操作前自动重新请求授权

### Q4: 如何知道用户授权了哪些模板？

**A:** 在控制台查看授权结果：

```javascript
const app = getApp();
const authResult = await app.requestSubscribeMessage();
console.log('授权结果:', authResult);
// 会显示：
// {
//   accepted: 2,        // 已授权数量
//   rejected: 0,        // 已拒绝数量
//   allAccepted: true,  // 是否全部授权
//   acceptedIds: [...], // 已授权的模板ID列表
//   rejectedIds: [...]  // 已拒绝的模板ID列表
// }
```

## 预防措施

### 1. 首次登录时详细说明

在首次登录时，显示详细的授权说明：
- 说明需要授权两个模板
- 说明每个模板的用途
- 强调授权的重要性

### 2. 授权后检查结果

授权后自动检查结果：
- 如果全部授权成功，显示成功提示
- 如果部分授权，显示详细提示，询问是否重新授权
- 如果全部拒绝，显示提示，建议重新授权

### 3. 定期检查授权状态

在关键操作前检查授权状态：
- 如果未全部授权，提示用户授权
- 提供"重新授权"选项

## 总结

如果遇到"一个成功，一个失败"的问题：

1. ✅ 检查模板ID配置是否正确
2. ✅ 清除授权状态
3. ✅ 重新授权，确保两个模板都授权
4. ✅ 验证授权结果
5. ✅ 测试消息推送

如果问题仍然存在，请检查：
- 模板ID是否配置正确
- 后端和小程序的模板ID是否一致
- 用户是否真的授权了两个模板

