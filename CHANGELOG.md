# 更新日志

## [2.0.0] - 2024-12-04 🎉

### 🎉 第一阶段优化完成 - 系统达到生产就绪状态

本次更新完成了系统的全面安全加固和性能优化，标志着第一阶段优化工作圆满完成。

#### 🔒 安全性增强

##### 1. 密码安全增强
- ✅ 修复密码截断问题（SHA256预哈希）
- ✅ 添加密码强度验证（8位+大小写+数字）
- ✅ 创建密码修改日志表和功能
- ✅ 编写8个测试用例（100%通过）

##### 2. API安全加固
- ✅ 实现频率限制中间件（60次/分钟，1000次/小时）
- ✅ 添加请求体大小限制（10MB）
- ✅ 增强CORS配置支持白名单
- ✅ 生产环境安全警告

##### 3. 错误处理完善 ⭐ 新增
- ✅ 创建7种自定义异常类
  - BusinessException - 业务异常（400）
  - ValidationException - 验证异常（422）
  - NotFoundException - 资源不存在（404）
  - PermissionDeniedException - 权限拒绝（403）
  - ConflictException - 数据冲突（409）
  - AuthenticationException - 认证失败（401）
  - RateLimitException - 频率限制（429）
- ✅ 全局异常处理器
- ✅ 统一错误响应格式 `{code, message, detail}`
- ✅ 错误信息脱敏（生产环境隐藏detail）
- ✅ 详细错误日志记录（路径、方法、客户端IP）
- ✅ 自动处理数据库异常（UNIQUE、FOREIGN KEY、NOT NULL）
- ✅ 编写17个测试用例（100%通过）

##### 4. 并发控制
- ✅ 在User、LeaveApplication、OvertimeApplication表添加version字段
- ✅ 创建乐观锁装饰器
- ✅ 处理并发冲突异常（返回409状态码）
- ✅ 编写9个测试用例（100%通过）

#### ⚡ 性能优化

##### 1. 数据库优化
- ✅ 添加11个性能索引
  - attendances表：(user_id, date)、user_id、date
  - leave_applications表：(user_id, status)、user_id、status
  - overtime_applications表：(user_id, status)、user_id、status
  - users表：username、department_id
- ✅ 创建索引迁移脚本
- ✅ 预期查询性能提升50-95%

##### 2. 查询日志和监控
- ✅ 创建查询日志系统（慢查询阈值0.1秒）
- ✅ 创建监控路由（查询统计API）
- ✅ 详细健康检查API
- ✅ 系统资源监控

#### 🛠️ 开发工具

##### 1. 代码质量工具
- ✅ 创建requirements-dev.txt（pytest、black、flake8、mypy等）
- ✅ 创建.editorconfig（统一编辑器配置）
- ✅ 创建pyproject.toml（black、isort、mypy、pytest配置）
- ✅ 创建.flake8（代码检查配置）
- ✅ 创建Makefile（简化常用命令）

##### 2. 时区处理工具
- ✅ 创建后端时区工具类（timezone.py）
- ✅ 创建前端时区工具（datetime.js）
- ✅ 编写14个测试用例（100%通过）

#### 📚 文档完善

- ✅ 错误处理使用指南（ERROR_HANDLING_GUIDE.md）
- ✅ 安全功能指南（SECURITY_FEATURES_GUIDE.md）
- ✅ 快速开始指南（QUICK_START_SECURITY.md）
- ✅ 多个优化总结文档

#### 📊 统计数据

**新增文件**：36个
- 功能模块：17个
- 测试文件：4个
- 文档：10个
- 配置文件：5个

**新增代码**：约3430行
- 功能代码：约2500行
- 测试代码：约330行
- 文档：约600行

**新增测试**：46个（100%通过）
- 密码安全：8个
- 时区处理：14个
- 乐观锁：9个
- 异常处理：17个

**新增索引**：11个

#### 🎯 改进效果

| 方面 | 优化前 | 优化后 | 提升 |
|-----|-------|-------|-----|
| 密码安全 | 基础bcrypt | SHA256预哈希+强度验证+审计日志 | ⭐⭐⭐⭐⭐ |
| API防护 | 无限制 | 频率限制+大小限制+CORS白名单 | ⭐⭐⭐⭐⭐ |
| 错误处理 | 零散 | 统一格式+脱敏+详细日志 | ⭐⭐⭐⭐⭐ |
| 并发控制 | 无 | 乐观锁+版本管理 | ⭐⭐⭐⭐⭐ |
| 数据库查询 | 无索引 | 11个索引 | 50-95% |
| 测试覆盖 | 0% | 100%（新功能） | ⭐⭐⭐⭐⭐ |

#### 🚀 快速开始

```bash
# 安装开发依赖
make install-dev

# 执行数据库迁移
make migrate

# 运行测试
make test

# 代码质量检查
make check

# 启动应用
make run
```

#### 📖 相关文档

- [错误处理使用指南](./docs/ERROR_HANDLING_GUIDE.md)
- [安全功能指南](./docs/SECURITY_FEATURES_GUIDE.md)
- [快速开始指南](./QUICK_START_SECURITY.md)
- [第一阶段完成报告](./OPTIMIZATION_FINAL_COMPLETE_2024-12-04.md)

---

## [Unreleased] - 2024-11-15

### 🎉 重要变更

#### 考勤记录查询功能增强

**功能描述：**
- ✅ 新增"按月查询"功能：快速选择月份，自动计算该月的开始和结束日期
- ✅ 保留"自定义日期查询"功能：灵活选择任意日期范围
- ✅ 新增"按员工查询"功能：可以筛选特定员工的考勤记录
- ✅ 查询方式切换：通过下拉菜单在"按月查询"和"自定义日期"之间切换
- ✅ 默认显示当前月份的考勤记录

**显示效果：**
```
查询条件：
┌─────────────────────────────────────────────────────────┐
│ 查询方式: [按月查询 ▼] 月份: [2025-11] 员工: [全部员工 ▼] [查询] │
│                                                         │
│ 或                                                      │
│                                                         │
│ 查询方式: [自定义日期 ▼] 开始: [2025-11-08] 结束: [2025-11-28] │
│           员工: [全部员工 ▼] [查询]                      │
└─────────────────────────────────────────────────────────┘
```

**技术实现：**
- 后端：在 `/api/attendance/` 接口中添加 `user_id` 参数支持
- 前端：添加查询类型切换、月份选择、员工选择功能
- 前端：自动计算月份的开始和结束日期

#### 后台考勤记录新增打卡位置显示（已优化为异步+缓存）

**功能描述：**
- ✅ 在后台管理界面的考勤记录表格中新增"上班位置"和"下班位置"列
- ✅ **异步加载地址**：先显示坐标，后台异步转换为地址文本，不阻塞页面加载
- ✅ **智能缓存机制**：相同经纬度的地址会被缓存30天，大幅减少API调用
- ✅ **批量处理**：使用批量接口一次性转换多个地址，提高效率
- ✅ **并发控制**：限制并发数为10，避免过多API调用
- ✅ 位置信息自动换行，避免表格过宽
- ✅ 如果未打卡或没有位置信息，显示"-"
- ✅ 坐标格式的位置显示为灰色，地址文本显示为深色，便于区分

**技术实现：**
- 后端：新增 `/api/attendance/geocode/batch` 批量地址转换接口
- 后端：创建 `geocode_cache.py` 缓存模块，使用内存缓存
- 前端：异步调用批量接口，动态更新表格中的地址显示
- 缓存：经纬度四舍五入到小数点后4位作为缓存键，减少缓存数量

**显示效果：**
```
考勤记录表格：
┌──────┬──────┬──────────┬──────────────┬──────────┬──────────────┬──────┬──────┬──────┐
│ 日期 │ 员工 │ 上班打卡 │ 上班位置     │ 下班打卡 │ 下班位置     │ 工时 │ 迟到 │ 早退 │
├──────┼──────┼──────────┼──────────────┼──────────┼──────────────┼──────┼──────┼──────┤
│ ...  │ 杨娟 │ 09:00    │ 北京市朝阳区 │ 18:00    │ 北京市朝阳区 │ 8.0h │ 否   │ 否   │
│      │      │          │ 建国路88号   │          │ 建国路88号   │      │      │      │
└──────┴──────┴──────────┴──────────────┴──────────┴──────────────┴──────┴──────┴──────┘
```

#### 新增位置地址文本显示和保存功能（已升级为高德地图）

**功能描述：**
- ✅ 打卡时自动获取并显示具体位置文本（地址），而不仅仅是坐标
- ✅ 位置地址文本保存到考勤记录中（`checkin_location` 和 `checkout_location` 字段）
- ✅ **使用高德地图API进行逆地理编码**，将经纬度转换为地址（更准确、更快速）
- ✅ 如果地址获取失败，则显示坐标作为备选方案
- ✅ 兼容旧版本：如果地址为空，则使用坐标字符串

**显示效果：**
```
修改前：
位置: 34.959208, -116.419389  ← 只显示坐标

修改后：
位置: 北京市朝阳区建国路88号SOHO现代城  ← 显示具体地址文本 ✅
```

**技术实现：**
- 后端：新增 `/api/attendance/geocode/reverse` 接口，调用高德地图API获取地址
- 前端：调用后端接口获取地址文本
- 后端：在 `AttendanceCheckin` 和 `AttendanceCheckout` schema 中添加 `address` 字段
- 数据库：地址文本保存到 `checkin_location` 和 `checkout_location` 字段

**配置说明：**
需要在 `.env` 文件中配置高德地图 API Key：
```env
AMAP_API_KEY=your-amap-api-key
```

获取高德地图 API Key：
1. 访问 https://console.amap.com/dev/key/app
2. 注册/登录高德开放平台账号
3. 创建应用，选择"Web服务"类型
4. 获取 API Key 并配置到 `.env` 文件中

**注意：**
- 高德地图API有免费额度，适合小规模使用
- API Key 配置在后端，不会暴露给前端，更安全
- 如果未配置 API Key，系统会返回坐标作为备选方案

#### 新增审批页面详情功能

**功能描述：**
- ✅ 在请假审批和加班审批页面添加"详情"按钮
- ✅ 点击详情按钮可以查看申请的完整信息，包括申请人、申请时间、审批流程等
- ✅ 详情弹窗中正确显示申请人姓名（而非当前登录用户）
- ✅ 方便审批人在审批前查看完整的申请信息
- ✅ 优化详情页面布局：状态显示在第一行，所有字段标题和值在同一行显示

**显示效果：**
```
审批页面列表：
┌─────────────────────────────┐
│ 2025/11/15 ~ 2025/11/17     │
│ 天数: 3天                    │
│ 原因: 事假                   │
│ [详情] [批准] [拒绝]         │ ← 新增详情按钮
└─────────────────────────────┘

详情弹窗：
┌─────────────────────────────┐
│ 请假详情                     │
│ 申请人: 杨娟                 │ ← 显示实际申请人
│ 开始日期: 2025/11/15        │
│ 结束日期: 2025/11/17        │
│ 天数: 3天                   │
│ 原因: 事假                  │
│ 状态: 待审批                │
│ ...                          │
└─────────────────────────────┘
```

#### 优化移动端请假/加班管理 - 审批信息仅详情显示

**改进内容：**
- ✅ 请假管理和加班管理的记录列表中不再显示审批人和审批时间
- ✅ 审批人和审批时间信息仅在详情弹窗中显示
- ✅ 简化列表显示，提升用户体验

**显示效果：**
```
修改前：
列表显示：
- 天数: 1天
- 原因: 加班一天
- 申请时间: 2025/11/15 17:24
- 审批人: 牛鋆辉          ← 列表中也显示
- 审批时间: 2025/11/15 18:18  ← 列表中也显示
[详情] 按钮

修改后：
列表显示：
- 天数: 1天
- 原因: 加班一天
- 申请时间: 2025/11/15 17:24
[详情] 按钮

详情弹窗中显示：
- 审批人: 牛鋆辉          ← 仅在详情中显示
- 审批时间: 2025/11/15 18:18  ← 仅在详情中显示
```

#### 优化考勤记录显示 - 迟到早退红色标识

**改进内容：**
- ✅ 考勤记录中，如果迟到或早退列显示"是"，则用红色显示
- ✅ 使用红色（#FF3B30）和加粗字体，更加醒目
- ✅ 方便管理员快速识别异常考勤记录

**显示效果：**
```
修改前：
迟到: 是  （黑色）
早退: 是  （黑色）

修改后：
迟到: 是  （红色加粗）✅
早退: 是  （红色加粗）✅
```

#### 优化节假日配置 - 动态年份显示

**改进内容：**
- ✅ 年份下拉菜单现在根据已添加的节假日记录动态生成
- ✅ 只显示有记录的年份，不再显示固定年份列表
- ✅ 年份按从大到小排序（最新年份在前）
- ✅ 自动选择第一个有记录的年份

**显示效果：**
```
修改前：
年份下拉：2024年、2025年、2026年（固定）

修改后：
年份下拉：2025年、2024年（根据实际记录动态生成）
```

#### 修复后台管理节假日配置弹窗问题

**问题描述：**
- 添加节假日的弹出窗口位置错误
- 表单输入框无法填写

**修复内容：**
- ✅ 修复弹窗HTML结构，添加 `onclick="event.stopPropagation()"` 防止点击弹窗内部时关闭
- ✅ 修复 `modal-overlay` 的点击事件处理，使用 `onclick="closeModal(event)"`
- ✅ 移除不存在的 `form-control` 类，使用 `.form-group input` 自动样式
- ✅ 添加 `modal-header` 和 `modal-close` 样式类
- ✅ 修复添加和编辑节假日弹窗的结构

**技术细节：**
- 弹窗结构与其他弹窗保持一致
- 表单元素样式通过 `.form-group input` 自动应用
- 关闭按钮样式优化，支持悬停效果

#### 新增已取消记录的删除功能

**功能说明：**
- ✅ 已取消的请假和加班申请现在可以由申请人删除
- ✅ 在移动端和后台管理的已取消记录中显示"删除"按钮
- ✅ 删除操作需要二次确认，防止误删
- ✅ 只有申请人或管理员可以删除记录

**功能特点：**
- **权限控制**：只有申请人本人或管理员可以删除
- **状态限制**：只能删除状态为"已取消"的记录
- **安全提示**：删除前会弹出确认对话框，提示"删除后无法恢复"
- **即时刷新**：删除成功后自动刷新列表

**使用场景：**
- 员工撤回申请后，如果不再需要该记录，可以删除
- 清理已取消的申请记录，保持列表整洁
- 管理员可以协助删除已取消的记录

**显示效果：**
```
已取消的请假记录：
┌─────────────────────────────────┐
│ 2025/11/15 ~ 2025/11/15 [已取消]│
│ ...                             │
│ [删除]  ← 红色删除按钮          │
└─────────────────────────────────┘
```

**技术实现：**
- 后端：新增 `DELETE /api/leave/{leave_id}/delete` 和 `DELETE /api/overtime/{overtime_id}/delete` API
- 前端：在已取消记录中添加删除按钮和删除函数
- 权限验证：检查申请人身份和记录状态

#### 删除加班申请中的时长相关信息

**修改内容：**
- ✅ 删除移动端加班申请表单中的"预计时长"输入框
- ✅ 删除移动端加班记录列表中的"时长"显示
- ✅ 删除移动端加班详情弹窗中的"时长"显示
- ✅ 删除移动端审批页面中的"时长"显示
- ✅ 删除后台管理加班详情弹窗中的"时长"显示，改为显示"天数"
- ✅ 删除相关的时长计算函数（`updateOvertimeHours`、`calculateHours`）

**影响范围：**
- 移动端：加班申请表单、加班记录列表、加班详情、审批页面
- 后台管理：加班详情弹窗
- 统计功能：已使用天数统计，不受影响

**说明：**
- 系统现在统一使用"天数"作为加班统计单位
- 半天 = 0.5天，整天 = 1天，自定义 = x.5天
- 不再显示和统计加班时长（小时）

#### 移动端新增请假/加班详情功能

**功能说明：**
- ✅ 在移动端请假和加班管理中，已批准或被拒绝的申请现在显示"详情"按钮
- ✅ 点击详情按钮可以查看完整的申请信息和审批流程
- ✅ 详情弹窗显示所有审批步骤（部门主任、副总、总经理）的审批信息
- ✅ **修复审批人显示问题**：详情弹窗中现在正确显示审批人的真实姓名（而不是"用户X"）

**功能特点：**
- **请假详情**：显示申请人、日期范围、天数、原因、状态，以及完整的审批流程（部门主任审批、副总审批、总经理审批）
- **加班详情**：显示申请人、时间范围、时长、天数、原因、状态，以及审批信息
- **美观界面**：详情弹窗采用卡片式设计，信息层次清晰
- **完整信息**：显示所有审批人的姓名、审批时间和审批意见

**使用场景：**
- 员工可以查看自己已批准或被拒绝的请假/加班申请的完整详情
- 了解审批流程的每个步骤
- 查看审批人的具体意见

**显示效果：**
```
请假详情弹窗：
- 申请人：杨娟
- 开始日期：2025/11/15
- 结束日期：2025/11/15
- 天数：1天
- 原因：请假一天
- 状态：已批准

部门主任审批：
- 审批人：牛鋆辉
- 时间：2025/11/15 16:47
- 意见：无

[关闭按钮]
```

#### 优化后台考勤记录显示

**改进内容：**
- ✅ 上班打卡和下班打卡列现在只显示时间（如：16:51），不显示日期
- ✅ 因为已有日期列，避免重复显示日期信息
- ✅ 界面更加简洁清晰

**显示效果：**
```
修改前：
日期        员工  上班打卡             下班打卡
2025/11/12  杨娟  2025/11/12 16:51    -

修改后：
日期        员工  上班打卡  下班打卡
2025/11/12  杨娟  16:51     -
```

#### 修复移动端请假/加班记录显示问题

**问题描述：**
- 普通员工无法查看自己的请假和加班记录
- 因为前端尝试获取所有用户列表（需要管理员权限），导致加载失败

**修复内容：**
- ✅ 后端 `LeaveApplicationResponse` / `OvertimeApplicationResponse` 新增审批人姓名字段
- ✅ `get_my_leave_applications()` / `get_my_overtime_applications()` 自动返回审批人姓名
- ✅ 移动端前端不再请求 `/users/` API，即使是普通员工也能看到审批人姓名
- ✅ 请假/加班记录列表稳定显示审批信息

**技术实现：**
- 后端查询审批人ID并映射真实姓名
- Pydantic响应模型新增 `dept_approver_name`、`vp_approver_name`、`gm_approver_name`、`approver_name`
- 前端直接使用响应中的姓名字段

**用户体验：**
- 所有员工都能正常查看请假和加班记录
- 审批人显示真实姓名（如“牛鋆辉”），不再出现“用户7”

#### 优化统计分析 - 应出勤天数智能计算

**功能说明：**
- 统计分析中的"应出勤天数"现在会自动计算实际工作日天数
- 排除周末（周六、周日）
- 排除法定节假日
- 包含调休工作日（周末上班）

**影响范围：**
- ✅ **出勤统计**：应出勤天数 = 日期范围内的实际工作日天数
- ✅ **周期统计**：应出勤次数 = 活跃用户数 × 实际工作日天数
- ✅ **个人统计**：应出勤天数 = 日期范围内的实际工作日天数

**示例：**
```
统计周期：2025年1月1日 - 2025年1月31日（共31天）
- 普通周末：4个周六 + 4个周日 = 8天
- 法定节假日：元旦1天（1月1日）
- 调休工作日：0天
实际工作日 = 31 - 8 - 1 + 0 = 22天
应出勤天数 = 22天（而不是31天）
```

**技术实现：**
- 新增 `calculate_workdays()` 函数
- 查询节假日配置数据库
- 智能识别每一天的类型（工作日/周末/节假日/调休）

#### 新增法定节假日管理功能

**功能说明：**
- 管理员可在后台配置法定节假日和调休工作日
- 系统自动识别节假日，在节假日期间禁用打卡按钮
- 支持调休工作日配置（周末上班）
- 已预置2025年全年法定节假日数据

**核心功能：**
- ✅ **节假日配置界面**：管理后台新增"节假日配置"页面
- ✅ **两种类型**：休息日（法定节假日）/ 调休工作日（周末上班）
- ✅ **CRUD操作**：添加、编辑、删除节假日配置
- ✅ **按年筛选**：可按年份查看节假日列表
- ✅ **智能判断**：移动端自动调用API检查是否为工作日
- ✅ **友好提示**：根据不同情况显示对应提示信息

**预置数据：**
- 元旦（1月1日）
- 春节（1月28日-2月4日，共8天）+ 调休（1月26日、2月8日上班）
- 清明节（4月4日-6日）
- 劳动节（5月1日-5日）+ 调休（4月27日上班）
- 端午节（5月31日-6月2日）
- 中秋节（10月6日-8日）+ 调休（9月28日、10月11日上班）
- 国庆节（10月1日-5日）

**技术实现：**
- 后端：新增 `Holiday` 模型和 `/api/holidays/` API
- 前端：管理后台新增节假日管理界面
- 移动端：调用 `/api/holidays/check/{date}` API检查工作日
- 数据库：新增 `holidays` 表

详细说明见 [工作日打卡限制功能文档](./FEATURE_WORKDAY_CHECK.md)

#### 新增工作日打卡限制功能

**功能说明：**
- 移动端首页自动判断当前日期是否为工作日
- 只有工作日（周一至周五）才能使用打卡按钮
- 周末（周六、周日）自动禁用打卡按钮并显示提示信息

**功能特点：**
- ✅ **自动判断**：页面加载时自动检测是否为工作日
- ✅ **友好提示**：非工作日显示"今天是周X，非工作日无需打卡"
- ✅ **视觉反馈**：非工作日按钮半透明禁用，提示文字橙色加粗
- ✅ **双重保护**：按钮禁用 + 函数内部检查，防止绕过

**界面表现：**
- **工作日**：打卡按钮正常启用，可以正常打卡
- **休息日**：打卡按钮禁用（半透明），位置栏显示提示信息

详细说明见 [工作日打卡限制功能文档](./FEATURE_WORKDAY_CHECK.md)

**注意：** 目前仅判断周末，法定节假日和调休日需要后续扩展。

#### 新增申请撤回功能

**功能说明：**
- 用户可以撤回自己提交的请假和加班申请
- 只能撤回待审批状态的申请
- 已审批（通过或拒绝）的申请不能撤回

**适用范围：**
- **请假申请**：可撤回待审批、部门已批、副总已批状态
- **加班申请**：可撤回待审批状态

详细说明见 [申请撤回功能文档](./FEATURE_CANCEL.md)

#### 加班统计改为按天数计算

**变更说明：**
- 加班统计从"小时"改为"天数"显示
- 加班申请时需要明确天数
  - **半天**：固定计为 0.5 天
  - **整天**：固定计为 1 天
  - **自定义**：手动填写天数（只能是整数或 x.5 天，如 1、1.5、2、2.5）

**数据库变更：**
- `overtime_applications` 表新增 `days` 字段（Float类型）
- API响应中 `overtime_hours` 改为 `overtime_days`

**影响范围：**
- 后端 API：`/statistics/` 接口返回数据结构变更
- 前端统计页面：显示"加班天数"而非"加班时长(h)"
- 加班申请表单：增加天数输入和验证

**升级方式：**
1. 运行迁移脚本（保留现有数据）：
   ```bash
   python migrate_db.py
   ```
2. 或重新初始化数据库（清空数据）：
   ```bash
   # Windows
   del attendance.db
   python init_db.py
   
   # Linux/Mac
   rm attendance.db
   python init_db.py
   ```

### ✨ 新增功能
- **审批权限控制**：前端基于用户角色显示/隐藏审批功能
  - 普通员工不显示审批入口
  - 只有部门主任、副总、总经理、管理员可访问审批功能
  - 多层权限验证（前端隐藏 + JavaScript拦截 + 后端验证）
- **统计分析模块重构**：拆分为总统计、出勤统计、请假统计、加班统计四大模块
  - 总统计：卡片式展示总体数据
  - 出勤统计：详细的员工考勤数据
  - 请假统计：请假天数、次数、占比分析
  - 加班统计：加班天数、次数、时长统计
  - 标签页切换，清晰分类
  - 智能筛选和排序
- 加班申请支持自定义天数
- 加班天数格式验证（前后端双重验证）

### ✨ 新增功能
- **打卡自动刷新**：上班打卡或下班打卡成功后自动刷新首页数据
  - 自动更新今日打卡记录
  - 自动更新最近打卡记录
  - 自动更新待审批数量
  - 提升用户体验，无需手动刷新
- **审批详情显示**：请假和加班管理显示完整审批信息
  - 添加申请时间、审批人、审批时间列（管理后台）
  - 移动端显示详细的审批人和审批时间
  - 多级审批显示当前审批进度
  - 便于追溯审批记录和效率分析
- **按月统计功能**：管理后台统计分析支持按月快速统计
  - 新增月份选择器（type="month"）
  - 自动计算月份的开始和结束日期
  - 智能处理不同月份的天数（28/29/30/31天）
  - 默认选择当前月份
  - 保留自定义日期范围选项
  - 支持快速切换统计方式
- **每周差异化打卡规则**：支持每周不同日期设置不同的下班时间
  - 数据库新增 `weekly_rules` 字段存储 JSON 格式的每周规则
  - 后端自动根据日期应用对应的规则判断早退
  - 前端管理界面支持可视化配置每周7天的特殊规则
  - 示例：周一至周四17:30下班，周五12:00下班

### 🐛 Bug修复
- **修复SQLAlchemy枚举类型兼容性问题（重要）**
  - 问题：个人加班管理中看不到加班记录
  - 原因：SQLEnum在SQLite中使用枚举名称（大写）而非值（小写）
  - 修复：将status列从SQLEnum改为String(20)
  - 影响：加班申请、请假申请的状态字段
  - 需要重建数据库以应用新schema
- **修复加班统计数据不准确的问题**
  - 修复了数据库状态值大小写不匹配问题（APPROVED vs approved）
  - 创建了 `fix_overtime_status.py` 脚本自动修复历史数据
  - 修正了统计查询中加班记录的过滤条件
  - 之前的条件过于严格导致加班记录被排除
  - 现在正确统计日期范围内的所有已批准加班记录
- **优化加班统计界面**
  - 移除了不必要的"加班时长(h)"列
  - 简化表格显示，只保留天数和次数

### 🔧 技术改进
- **用户删除保护机制**：防止删除有关联数据的用户
  - 删除前检查考勤、请假、加班记录
  - 有关联数据时拒绝删除并显示详细提示
  - 建议使用停用功能代替删除
  - 改进前端错误处理，正确显示服务器错误信息
- 统计逻辑优化：直接使用天数字段，无需转换
- 数据验证：Pydantic validator 确保天数只能是 0.5 的倍数

---

## [1.0.0] - 2024-11-14

### 🎉 初始版本发布

#### 主要功能
- **用户管理**：多角色权限系统（管理员、总经理、副总、部门主任、员工）
- **部门管理**：支持多部门组织架构
- **考勤管理**：
  - GPS定位打卡（精确到建筑/街道）
  - 自动识别迟到/早退
  - 工时统计
- **请假管理**：
  - 多级审批流程（根据请假天数自动路由）
  - 1天：部门主任审批
  - 1-3天：部门主任 → 副总
  - >3天：部门主任 → 副总 → 总经理
- **加班管理**：
  - 加班申请与审批（部门主任审批）
  - 支持半天、整天、自定义时长
- **统计分析**：
  - 个人考勤统计
  - 部门考勤统计
  - 周期性统计报表

#### 技术栈
- **后端**：FastAPI + SQLite + SQLAlchemy
- **前端**：原生 HTML/CSS/JavaScript
- **认证**：JWT Token
- **部署**：支持 Docker 部署

#### 界面特性
- 现代化 Apple 风格 UI
- 响应式设计，支持移动端浏览器
- 管理后台与移动端分离


