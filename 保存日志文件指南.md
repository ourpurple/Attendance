# 保存日志文件指南

## 使用 systemctl 管理服务时的日志保存

当你使用 `sudo systemctl restart attendance-backend` 启动服务时，日志由 systemd journal 管理。以下是保存日志文件的各种方法。

## 基本保存方法

### 1. 保存所有日志

```bash
# 保存所有历史日志到文件
sudo journalctl -u attendance-backend > /tmp/attendance_all.log

# 保存到项目目录
sudo journalctl -u attendance-backend > /www/wwwroot/attendance-system/logs/attendance_all.log
```

### 2. 保存今天的日志

```bash
# 保存今天的日志
sudo journalctl -u attendance-backend --since today > /tmp/attendance_today.log

# 保存到项目目录，文件名包含日期
sudo journalctl -u attendance-backend --since today > /www/wwwroot/attendance-system/logs/attendance_$(date +%Y%m%d).log
```

### 3. 保存最近N行日志

```bash
# 保存最近100行
sudo journalctl -u attendance-backend -n 100 > /tmp/attendance_recent.log

# 保存最近1000行
sudo journalctl -u attendance-backend -n 1000 > /tmp/attendance_recent.log
```

### 4. 保存指定时间段的日志

```bash
# 保存今天的日志
sudo journalctl -u attendance-backend --since "2025-11-20 00:00:00" --until "2025-11-20 23:59:59" > /tmp/attendance_20251120.log

# 保存最近1小时的日志
sudo journalctl -u attendance-backend --since "1 hour ago" > /tmp/attendance_last_hour.log

# 保存最近24小时的日志
sudo journalctl -u attendance-backend --since "24 hours ago" > /tmp/attendance_last_24h.log
```

### 5. 保存错误日志

```bash
# 只保存错误级别的日志
sudo journalctl -u attendance-backend -p err > /tmp/attendance_errors.log

# 保存警告和错误日志
sudo journalctl -u attendance-backend -p warning > /tmp/attendance_warnings.log
```

### 6. 保存特定内容的日志

```bash
# 保存包含"审批结果通知"的日志
sudo journalctl -u attendance-backend | grep "审批结果通知" > /tmp/attendance_approval_result.log

# 保存包含"订阅消息"的日志
sudo journalctl -u attendance-backend | grep "订阅消息" > /tmp/attendance_subscribe.log

# 保存包含"错误"的日志
sudo journalctl -u attendance-backend | grep -i "error\|失败\|异常" > /tmp/attendance_errors_filtered.log
```

## 高级保存方法

### 1. 实时保存日志（追加模式）

```bash
# 实时追加日志到文件（按 Ctrl+C 停止）
sudo journalctl -u attendance-backend -f >> /tmp/attendance_live.log

# 后台运行实时保存
nohup sudo journalctl -u attendance-backend -f >> /tmp/attendance_live.log &
```

### 2. 保存为JSON格式

```bash
# 保存为JSON格式（便于程序处理）
sudo journalctl -u attendance-backend --since today -o json > /tmp/attendance.json
```

### 3. 保存为简洁格式

```bash
# 保存为简洁格式（不包含时间戳和主机名）
sudo journalctl -u attendance-backend --since today -o short > /tmp/attendance_short.log
```

### 4. 保存并压缩

```bash
# 保存并压缩
sudo journalctl -u attendance-backend --since today | gzip > /tmp/attendance_$(date +%Y%m%d).log.gz

# 解压查看
gunzip -c /tmp/attendance_20251120.log.gz | less
```

## 自动化保存脚本

### 创建日志保存脚本

创建文件 `/www/wwwroot/attendance-system/deploy/save_logs.sh`：

```bash
#!/bin/bash
# 保存考勤系统日志

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
LOG_DIR="$PROJECT_DIR/logs"
SERVICE_NAME="attendance-backend"

# 创建日志目录
mkdir -p "$LOG_DIR"

# 生成日志文件名（包含日期时间）
LOG_FILE="$LOG_DIR/attendance_$(date +%Y%m%d_%H%M%S).log"

echo "正在保存日志到: $LOG_FILE"

# 保存今天的日志
sudo journalctl -u "$SERVICE_NAME" --since today > "$LOG_FILE"

# 压缩日志文件
gzip "$LOG_FILE"

echo "✅ 日志已保存并压缩: ${LOG_FILE}.gz"
echo "文件大小: $(du -h ${LOG_FILE}.gz | cut -f1)"
```

使用脚本：

```bash
# 添加执行权限
chmod +x /www/wwwroot/attendance-system/deploy/save_logs.sh

# 运行脚本
./deploy/save_logs.sh
```

### 定时自动保存日志

使用 cron 定时保存日志：

```bash
# 编辑 crontab
crontab -e

# 添加以下行（每天凌晨2点保存昨天的日志）
0 2 * * * sudo journalctl -u attendance-backend --since "yesterday" --until "today" | gzip > /www/wwwroot/attendance-system/logs/attendance_$(date -d yesterday +\%Y\%m\%d).log.gz
```

## 常用保存场景

### 场景1：保存重启前的日志

```bash
# 在重启服务前保存日志
sudo journalctl -u attendance-backend --since "1 hour ago" > /tmp/attendance_before_restart.log

# 重启服务
sudo systemctl restart attendance-backend

# 保存重启后的日志
sudo journalctl -u attendance-backend --since "5 minutes ago" > /tmp/attendance_after_restart.log
```

### 场景2：保存问题排查期间的日志

```bash
# 记录开始时间
START_TIME=$(date '+%Y-%m-%d %H:%M:%S')

# ... 进行问题排查操作 ...

# 记录结束时间
END_TIME=$(date '+%Y-%m-%d %H:%M:%S')

# 保存这个时间段的日志
sudo journalctl -u attendance-backend --since "$START_TIME" --until "$END_TIME" > /tmp/attendance_troubleshoot.log
```

### 场景3：保存特定功能的日志

```bash
# 保存审批相关的日志
sudo journalctl -u attendance-backend | grep -E "审批|approval" > /tmp/attendance_approval.log

# 保存微信消息推送相关的日志
sudo journalctl -u attendance-backend | grep -E "订阅消息|wechat|微信" > /tmp/attendance_wechat.log

# 保存错误和警告日志
sudo journalctl -u attendance-backend -p warning > /tmp/attendance_warnings.log
```

## 日志文件管理

### 查看保存的日志文件

```bash
# 列出所有日志文件
ls -lh /tmp/attendance*.log

# 查看日志文件大小
du -h /tmp/attendance*.log

# 查看日志文件内容
less /tmp/attendance_today.log
# 或
cat /tmp/attendance_today.log
```

### 清理旧日志文件

```bash
# 删除7天前的日志文件
find /tmp -name "attendance*.log" -mtime +7 -delete

# 删除7天前的压缩日志
find /www/wwwroot/attendance-system/logs -name "attendance*.log.gz" -mtime +7 -delete
```

### 日志文件大小限制

```bash
# 只保存最近1000行（避免文件过大）
sudo journalctl -u attendance-backend -n 1000 > /tmp/attendance_recent.log

# 保存并限制文件大小（使用 head 命令）
sudo journalctl -u attendance-backend --since today | head -n 10000 > /tmp/attendance_limited.log
```

## 快速保存命令

### 一键保存今天的日志

```bash
# 保存到临时目录
sudo journalctl -u attendance-backend --since today > /tmp/attendance_$(date +%Y%m%d).log

# 保存到项目目录
sudo journalctl -u attendance-backend --since today > /www/wwwroot/attendance-system/logs/attendance_$(date +%Y%m%d).log
```

### 一键保存最近的错误日志

```bash
sudo journalctl -u attendance-backend -p err -n 500 > /tmp/attendance_errors_$(date +%Y%m%d_%H%M%S).log
```

### 一键保存审批相关日志

```bash
sudo journalctl -u attendance-backend --since today | grep -E "审批|订阅消息" > /tmp/attendance_approval_$(date +%Y%m%d).log
```

## 注意事项

1. **文件权限**：保存的日志文件可能需要 sudo 权限才能创建
2. **磁盘空间**：定期清理旧日志文件，避免占用过多磁盘空间
3. **日志轮转**：建议使用 logrotate 或定时任务自动管理日志文件
4. **敏感信息**：日志中可能包含敏感信息，注意文件权限和存储位置

## 推荐做法

1. **日常保存**：每天保存一次日志到项目目录
2. **问题排查**：遇到问题时立即保存相关日志
3. **定期清理**：定期清理超过30天的日志文件
4. **压缩存储**：长期保存的日志建议压缩存储

## 示例：完整的日志保存流程

```bash
# 1. 创建日志目录
mkdir -p /www/wwwroot/attendance-system/logs

# 2. 保存今天的日志
sudo journalctl -u attendance-backend --since today > /www/wwwroot/attendance-system/logs/attendance_$(date +%Y%m%d).log

# 3. 压缩日志
gzip /www/wwwroot/attendance-system/logs/attendance_$(date +%Y%m%d).log

# 4. 查看保存的日志
ls -lh /www/wwwroot/attendance-system/logs/

# 5. 查看压缩的日志内容
gunzip -c /www/wwwroot/attendance-system/logs/attendance_20251120.log.gz | less
```

