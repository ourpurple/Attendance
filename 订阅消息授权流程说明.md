# 订阅消息授权流程说明

## 流程概述

```
a（申请人）提交申请 
  ↓
b（审批人）收到"待审批通知" 
  ↓
b（审批人）审核 
  ↓
a（申请人）收到"审批结果通知"
```

## 授权要求

### a（申请人）需要授权
- ✅ **审批结果通知模板** - 用于接收审批结果（通过/拒绝）

### b（审批人）需要授权
- ✅ **待审批通知模板** - 用于接收待审批的申请提醒

## 授权时机

### a（申请人）的授权时机

a 需要在以下场景中授权"审批结果通知"模板：

1. **登录时**（推荐）
   - 打开小程序登录页面
   - 登录成功后会自动弹出授权弹窗
   - 需要勾选"审批结果通知"并点击"允许"

2. **提交申请时**
   - 在请假/加班申请页面填写信息
   - 点击"提交"按钮时
   - 会弹出授权弹窗
   - 需要勾选"审批结果通知"并点击"允许"

### b（审批人）的授权时机

b 需要在以下场景中授权"待审批通知"模板：

1. **登录时**（推荐）
   - 打开小程序登录页面
   - 登录成功后会自动弹出授权弹窗
   - 需要勾选"待审批通知"并点击"允许"

2. **进入审批页面时**
   - 打开"审批"页面
   - 如果有审批权限，会自动弹出授权弹窗
   - 需要勾选"待审批通知"并点击"允许"

3. **进行审批操作时**
   - 在审批页面点击"通过"或"拒绝"按钮
   - 会弹出授权弹窗
   - 需要勾选"待审批通知"并点击"允许"

## 授权弹窗说明

当授权弹窗出现时，会显示两个模板：
- 📋 **待审批通知** - 用于审批人接收待审批申请
- 📋 **审批结果通知** - 用于申请人接收审批结果

**重要提示：**
- 用户可以选择性地允许或拒绝每个模板
- 如果拒绝某个模板，将无法收到对应类型的通知
- 授权有时效性，过期后需要重新授权

## 授权状态检查

### 如何知道是否已授权？

1. **查看授权结果**
   - 授权弹窗会显示每个模板的授权状态
   - `accept` 表示已允许，`reject` 表示已拒绝

2. **测试通知**
   - 进行一次完整的审批流程
   - 查看是否能收到相应的通知
   - 如果收不到，说明需要重新授权

## 常见问题

### Q1: a 提交申请时，b 能收到通知吗？

**A:** 可以，但前提是：
- b 已经授权了"待审批通知"模板
- b 的 openid 已正确绑定到系统

### Q2: b 审批后，a 能收到通知吗？

**A:** 可以，但前提是：
- a 已经授权了"审批结果通知"模板
- a 的 openid 已正确绑定到系统

### Q3: 如果之前拒绝了授权，怎么办？

**A:** 需要重新授权：
- 重新登录小程序
- 或进行提交申请/审批操作
- 在授权弹窗中重新勾选并允许

### Q4: 授权会过期吗？

**A:** 会的。微信订阅消息授权有时效性：
- 用户授权后，授权状态会保存一段时间
- 过期后需要重新授权
- 建议在每次登录时都请求授权

### Q5: 可以只授权一个模板吗？

**A:** 可以。授权弹窗会显示两个模板，用户可以选择性地允许或拒绝：
- 如果 a 只授权"审批结果通知"，只能收到审批结果，收不到待审批通知（如果 a 也是审批人）
- 如果 b 只授权"待审批通知"，只能收到待审批提醒，收不到审批结果通知（如果 b 也提交申请）

### Q6: 如果用户既是申请人也是审批人怎么办？

**A:** 建议同时授权两个模板：
- 这样既能收到待审批通知（作为审批人）
- 也能收到审批结果通知（作为申请人）

## 授权流程图

```
┌─────────────────────────────────────┐
│         a（申请人）登录/提交申请        │
└──────────────┬──────────────────────┘
               │
               ▼
      ┌─────────────────┐
      │  授权弹窗弹出     │
      │  - 待审批通知    │
      │  - 审批结果通知  │
      └────────┬────────┘
               │
               ▼
      ┌─────────────────┐
      │ a 允许"审批结果   │
      │   通知"模板      │
      └────────┬────────┘
               │
               ▼
┌─────────────────────────────────────┐
│      a 提交申请成功                  │
│      → 后端发送"待审批通知"给 b      │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│    b（审批人）收到待审批通知          │
│    （前提：b 已授权"待审批通知"）      │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│         b 进入审批页面/审批           │
└──────────────┬──────────────────────┘
               │
               ▼
      ┌─────────────────┐
      │  授权弹窗弹出     │
      │  - 待审批通知    │
      │  - 审批结果通知  │
      └────────┬────────┘
               │
               ▼
      ┌─────────────────┐
      │ b 允许"待审批    │
      │   通知"模板      │
      └────────┬────────┘
               │
               ▼
┌─────────────────────────────────────┐
│      b 审批完成                      │
│      → 后端发送"审批结果通知"给 a     │
└──────────────┬──────────────────────┘
               │
               ▼
┌─────────────────────────────────────┐
│    a 收到审批结果通知                │
│    （前提：a 已授权"审批结果通知"）    │
└─────────────────────────────────────┘
```

## 最佳实践

1. **首次使用建议**
   - 所有用户（申请人和审批人）都应该在首次登录时授权两个模板
   - 这样无论后续是申请还是审批，都能正常接收通知

2. **定期检查授权**
   - 如果发现通知收不到，检查授权状态
   - 重新登录或进行操作时会重新弹出授权弹窗

3. **授权提示**
   - 可以在小程序中添加提示，告知用户授权的重要性
   - 提醒用户如果拒绝授权，将无法收到重要通知

## 技术说明

### 授权触发位置

1. **登录时**：`miniprogram/pages/login/login.js`
   - 登录成功后自动调用 `requestSubscribeMessage()`

2. **提交申请时**：`miniprogram/pages/leave/apply/apply.js` 和 `miniprogram/pages/overtime/apply/apply.js`
   - 点击"提交"按钮时调用 `requestSubscribeMessage()`

3. **审批时**：`miniprogram/pages/approval/approval.js`
   - 进入审批页面时调用
   - 点击"通过"/"拒绝"按钮时调用

### 模板ID配置

模板ID在 `miniprogram/app.js` 中配置：

```javascript
subscribeTemplateIds: [
  '待审批通知模板ID',      // 审批人需要授权
  '审批结果通知模板ID'      // 申请人需要授权
]
```

**注意：** 这两个模板ID需要替换为实际的模板ID（从微信公众平台获取）。

