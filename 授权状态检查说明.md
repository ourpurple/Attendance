# 订阅消息授权状态检查说明

## 功能说明

现在系统已经增强了授权状态检查功能，可以准确判断两个模板是否都已授权成功。

## 授权状态检查

### 1. 授权结果详情

授权完成后，系统会返回详细的授权状态：

```javascript
{
  success: true,              // 是否成功调用授权API
  res: {...},                 // 微信返回的原始结果
  accepted: 2,                // 已接受的模板数量
  rejected: 0,               // 已拒绝的模板数量
  ban: 0,                    // 被禁止的模板数量
  total: 2,                  // 总模板数量
  allAccepted: true,         // 是否全部授权成功
  allRejected: false,        // 是否全部拒绝
  partialAccepted: false,    // 是否部分授权
  acceptedIds: [...],        // 已接受的模板ID列表
  rejectedIds: [...]         // 已拒绝的模板ID列表
}
```

### 2. 授权状态提示

系统会根据授权结果显示不同的提示：

#### ✅ 全部授权成功
- 显示成功提示："授权成功"
- 状态：`allAccepted: true`

#### ⚠️ 部分授权成功
- 显示提示："您已授权 X 个模板，拒绝了 Y 个模板"
- 建议允许所有模板授权
- 状态：`partialAccepted: true`

#### ❌ 全部拒绝
- 显示提示："您拒绝了订阅消息授权"
- 建议允许授权
- 状态：`allRejected: true`

### 3. 授权状态存储

系统会将授权状态保存到本地存储：

```javascript
{
  allAccepted: true,         // 是否全部授权成功
  acceptedCount: 2,          // 已接受的模板数量
  totalCount: 2,             // 总模板数量
  timestamp: 1234567890      // 授权时间戳
}
```

## 使用方法

### 1. 检查授权状态

```javascript
const app = getApp();

// 获取授权状态
const authStatus = app.getSubscribeMessageAuthStatus();
if (authStatus) {
  console.log('授权状态:', authStatus);
  console.log('是否全部授权:', authStatus.allAccepted);
  console.log('已授权数量:', authStatus.acceptedCount);
  console.log('总模板数量:', authStatus.totalCount);
}

// 检查是否全部授权
const isAllAuthorized = app.isAllSubscribeMessageAuthorized();
if (isAllAuthorized) {
  console.log('所有模板都已授权成功');
} else {
  console.log('还有模板未授权');
}
```

### 2. 在页面中使用

```javascript
// pages/example/example.js
const app = getApp();

Page({
  onLoad() {
    // 检查授权状态
    const authStatus = app.getSubscribeMessageAuthStatus();
    if (authStatus) {
      if (authStatus.allAccepted) {
        console.log('✅ 所有模板都已授权');
      } else if (authStatus.acceptedCount > 0) {
        console.log(`⚠️ 部分授权：${authStatus.acceptedCount}/${authStatus.totalCount}`);
      } else {
        console.log('❌ 未授权任何模板');
      }
    } else {
      console.log('未授权过');
    }
  }
});
```

## 授权流程优化

### 首次登录

1. 显示授权说明弹窗
2. 用户点击"去授权"
3. 显示微信授权弹窗
4. 用户操作后，检查授权结果：
   - 全部成功 → 显示"授权成功"
   - 部分成功 → 显示部分授权提示，询问是否重新授权
   - 全部拒绝 → 显示拒绝提示

### 非首次登录

1. 静默请求授权（不显示说明弹窗）
2. 检查授权结果
3. 如果之前是部分授权，现在全部授权成功，显示"授权已完成"

## 授权状态检查场景

### 1. 提交申请前

```javascript
// 提交申请前检查授权状态
const authStatus = app.getSubscribeMessageAuthStatus();
if (!authStatus || !authStatus.allAccepted) {
  // 请求授权
  await app.requestSubscribeMessage();
}
```

### 2. 审批前

```javascript
// 审批前检查授权状态
const isAllAuthorized = app.isAllSubscribeMessageAuthorized();
if (!isAllAuthorized) {
  // 请求授权
  await app.requestSubscribeMessage();
}
```

### 3. 页面加载时

```javascript
// 页面加载时检查授权状态
onLoad() {
  const authStatus = app.getSubscribeMessageAuthStatus();
  if (authStatus && !authStatus.allAccepted) {
    // 提示用户授权
    wx.showModal({
      title: '授权提醒',
      content: '您还有部分模板未授权，可能无法收到某些通知。是否现在授权？',
      success: (res) => {
        if (res.confirm) {
          app.requestSubscribeMessage();
        }
      }
    });
  }
}
```

## 调试方法

### 1. 查看授权状态

在微信开发者工具的控制台中：

```javascript
// 获取授权状态
const app = getApp();
const status = app.getSubscribeMessageAuthStatus();
console.log('授权状态:', status);

// 检查是否全部授权
const isAll = app.isAllSubscribeMessageAuthorized();
console.log('是否全部授权:', isAll);
```

### 2. 清除授权状态

```javascript
// 清除授权状态（用于测试）
wx.removeStorageSync('subscribe_message_authorized');
wx.removeStorageSync('subscribe_message_auth_status');
```

### 3. 查看授权结果

在授权完成后，查看控制台输出：

```javascript
// 授权结果会输出到控制台
console.log('订阅消息授权结果:', res);
```

## 常见问题

### Q1: 如何判断两个模板是否都已授权？

**A:** 使用 `app.isAllSubscribeMessageAuthorized()` 方法：

```javascript
const isAll = app.isAllSubscribeMessageAuthorized();
if (isAll) {
  console.log('✅ 两个模板都已授权成功');
} else {
  console.log('⚠️ 还有模板未授权');
}
```

### Q2: 如何查看具体的授权状态？

**A:** 使用 `app.getSubscribeMessageAuthStatus()` 方法：

```javascript
const status = app.getSubscribeMessageAuthStatus();
if (status) {
  console.log('已授权数量:', status.acceptedCount);
  console.log('总模板数量:', status.totalCount);
  console.log('是否全部授权:', status.allAccepted);
}
```

### Q3: 授权状态会过期吗？

**A:** 微信订阅消息授权有时效性，但系统会保存授权状态。如果授权过期，需要重新授权。

### Q4: 如何重新授权？

**A:** 清除授权状态后重新授权：

```javascript
// 清除授权状态
wx.removeStorageSync('subscribe_message_authorized');
wx.removeStorageSync('subscribe_message_auth_status');

// 重新授权
await app.requestSubscribeMessage([], {
  showTip: true
});
```

## 最佳实践

1. **首次登录时授权**
   - 系统会在首次登录时自动显示授权说明
   - 建议用户允许所有模板授权

2. **定期检查授权状态**
   - 在关键操作前检查授权状态
   - 如果未全部授权，提示用户授权

3. **授权状态提示**
   - 全部授权成功时显示成功提示
   - 部分授权时显示提醒，建议全部授权
   - 全部拒绝时显示提示，建议重新授权

4. **授权状态存储**
   - 系统会自动保存授权状态
   - 可以在任何地方检查授权状态
   - 方便统计和分析授权情况

