# 打卡策略测试指南

## 一、测试脚本使用

### 运行测试脚本

```bash
# 在项目根目录运行
python3 backend/test_attendance_policy.py
```

### 测试脚本功能

测试脚本会检查以下内容：

1. **策略加载测试**：检查是否有活跃的打卡策略
2. **日期规则测试**：测试特定日期的策略规则（包括每周规则）
3. **迟到检测测试**：测试迟到检测逻辑是否正确
4. **早退检测测试**：测试早退检测逻辑是否正确
5. **时间验证测试**：检查代码中是否有打卡时间范围验证
6. **每周规则测试**：测试每周特殊规则（如果配置了）

---

## 二、手动测试步骤

### 1. 检查策略配置

1. 登录管理后台
2. 进入"打卡策略"页面
3. 确认有一个策略被设置为"启用"状态
4. 记录以下信息：
   - 上班打卡时段（如：08:00 - 09:30）
   - 下班打卡时段（如：17:00 - 23:59）
   - 上班时间（如：09:00）
   - 下班时间（如：17:30）
   - 迟到阈值（分钟）
   - 早退阈值（分钟）

### 2. 测试上班打卡时间范围验证

**测试场景1：在允许的打卡时间内打卡**
- 时间：在策略规定的上班打卡时间范围内（如：08:00 - 09:30）
- 预期：打卡成功

**测试场景2：在允许的打卡时间外打卡（早于开始时间）**
- 时间：早于策略规定的上班打卡开始时间（如：07:59）
- 预期：打卡失败，提示"当前时间不在上班打卡时间范围内"

**测试场景3：在允许的打卡时间外打卡（晚于结束时间）**
- 时间：晚于策略规定的上班打卡结束时间（如：09:31）
- 预期：打卡失败，提示"当前时间不在上班打卡时间范围内"

### 3. 测试下班打卡时间范围验证

**测试场景1：在允许的打卡时间内打卡**
- 时间：在策略规定的下班打卡时间范围内（如：17:00 - 23:59）
- 预期：打卡成功

**测试场景2：在允许的打卡时间外打卡（早于开始时间）**
- 时间：早于策略规定的下班打卡开始时间（如：16:59）
- 预期：打卡失败，提示"当前时间不在下班打卡时间范围内"

**测试场景3：在允许的打卡时间外打卡（晚于结束时间）**
- 时间：晚于策略规定的下班打卡结束时间（如：次日00:00）
- 预期：打卡失败，提示"当前时间不在下班打卡时间范围内"

### 4. 测试迟到检测

**测试场景1：正常打卡（不迟到）**
- 时间：在上班时间之前或迟到阈值内
- 预期：打卡成功，`is_late = false`

**测试场景2：迟到打卡**
- 时间：超过上班时间 + 迟到阈值
- 预期：打卡成功，但 `is_late = true`

### 5. 测试早退检测

**测试场景1：正常打卡（不早退）**
- 时间：在下班时间之后或早退阈值内
- 预期：打卡成功，`is_early_leave = false`

**测试场景2：早退打卡**
- 时间：早于下班时间 - 早退阈值
- 预期：打卡成功，但 `is_early_leave = true`

### 6. 测试每周规则（如果配置了）

如果策略中配置了每周规则（如周五半天），测试：
- 周五的规则是否生效
- 其他工作日的规则是否正常

---

## 三、代码验证

### 已实现的验证逻辑

✅ **上班打卡时间范围验证**（`backend/routers/attendance.py` 第126-137行）
- 检查当前时间是否在 `checkin_start_time` 和 `checkin_end_time` 之间
- 如果不在范围内，返回 400 错误

✅ **下班打卡时间范围验证**（`backend/routers/attendance.py` 第205-216行）
- 检查当前时间是否在 `checkout_start_time` 和 `checkout_end_time` 之间
- 如果不在范围内，返回 400 错误

✅ **迟到检测**（`backend/routers/attendance.py` 第67-79行）
- 使用 `is_late()` 函数检测是否迟到
- 基于 `work_start_time` 和 `late_threshold_minutes`

✅ **早退检测**（`backend/routers/attendance.py` 第82-94行）
- 使用 `is_early_leave()` 函数检测是否早退
- 基于 `work_end_time` 和 `early_threshold_minutes`

✅ **每周规则支持**（`backend/routers/attendance.py` 第22-58行）
- `get_policy_for_date()` 函数支持每周特殊规则
- 通过 `weekly_rules` JSON 字段配置

---

## 四、测试检查清单

- [ ] 运行测试脚本，所有测试通过
- [ ] 在上班打卡时间范围内打卡，成功
- [ ] 在上班打卡时间范围外打卡，失败并提示错误
- [ ] 在下班打卡时间范围内打卡，成功
- [ ] 在下班打卡时间范围外打卡，失败并提示错误
- [ ] 正常打卡（不迟到），`is_late = false`
- [ ] 迟到打卡，`is_late = true`
- [ ] 正常打卡（不早退），`is_early_leave = false`
- [ ] 早退打卡，`is_early_leave = true`
- [ ] 每周规则（如果配置）正确应用

---

## 五、常见问题

### Q1: 测试脚本提示"未找到活跃的打卡策略"
**A:** 请在管理后台创建一个打卡策略并设置为"启用"状态。

### Q2: 打卡时间范围验证不生效
**A:** 检查：
1. 是否有活跃的打卡策略
2. 策略中的打卡时间范围是否正确配置
3. 服务器时间是否正确

### Q3: 每周规则不生效
**A:** 检查：
1. `weekly_rules` JSON 格式是否正确
2. 星期几的编号是否正确（0=周一, 6=周日）
3. 规则中的字段名是否与策略字段匹配

---

## 六、测试结果示例

```
============================================================
打卡策略测试脚本
============================================================

============================================================
测试1: 检查是否有活跃的打卡策略
============================================================
✅ 找到活跃策略: 标准工作制 (周五半天)
   上班时间: 09:00
   下班时间: 17:30
   上班打卡时段: 08:00 - 09:30
   下班打卡时段: 17:00 - 23:59
   迟到阈值: 0 分钟
   早退阈值: 0 分钟

============================================================
测试2: 测试特定日期的策略规则
============================================================
✅ 今天的策略规则:
   上班时间: 09:00
   下班时间: 17:30
   上班打卡时段: 08:00 - 09:30
   下班打卡时段: 17:00 - 23:59

   一周的策略规则:
   周一 (2025-11-17): 上班 09:00 - 下班 17:30, 打卡 08:00-09:30 / 17:00-23:59
   ...
   周五 (2025-11-21): 上班 09:00 - 下班 12:00, 打卡 08:00-09:30 / 11:00-23:59

============================================================
测试结果汇总
============================================================
   策略加载: ✅ 通过
   日期规则: ✅ 通过
   迟到检测: ✅ 通过
   早退检测: ✅ 通过
   时间验证: ✅ 通过
   每周规则: ✅ 通过

   总计: 6/6 测试通过

✅ 所有测试通过！打卡策略功能正常。
```

