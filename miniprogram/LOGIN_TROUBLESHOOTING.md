# 微信小程序登录问题排查指南

## 问题现象

- Mobile 前端可以正常登录
- 微信小程序无法登录
- 可能显示"登录失败"或网络错误

## 常见原因和解决方案

### 1. 微信公众平台未配置合法域名 ⚠️ **最常见**

**问题**：微信小程序要求所有网络请求必须使用已配置的合法域名。

**解决步骤**：

1. 登录[微信公众平台](https://mp.weixin.qq.com/)
2. 进入 **开发** → **开发设置**
3. 找到 **服务器域名** 配置
4. 在 **request合法域名** 中添加：
   ```
   https://oa.ruoshui-edu.cn
   ```
   **注意**：
   - 必须使用 HTTPS（不能是 HTTP）
   - 不需要加 `/api` 后缀
   - 不需要加端口号
   - 每个域名需要单独添加

5. 点击 **保存**
6. **重要**：配置后需要等待几分钟生效，或者重新编译小程序

**验证方法**：
- 在微信开发者工具中，查看控制台是否有域名相关的错误
- 如果看到 "不在以下 request 合法域名列表中" 的错误，说明域名未配置

### 2. 开发环境未开启"不校验合法域名"

**问题**：在开发阶段，如果不想配置合法域名，可以开启"不校验合法域名"选项。

**解决步骤**：

1. 打开微信开发者工具
2. 点击右上角的 **详情**
3. 在 **本地设置** 中
4. 勾选 **不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书**
5. 重新编译小程序

**注意**：此选项仅用于开发测试，正式版小程序必须配置合法域名。

### 3. API 地址配置错误

**检查步骤**：

1. 打开 `miniprogram/app.js`
2. 检查 `apiBaseUrl` 配置：
   ```javascript
   apiBaseUrl: 'https://oa.ruoshui-edu.cn/api'
   ```
3. 确保：
   - 使用 HTTPS（不是 HTTP）
   - 域名正确
   - 包含 `/api` 后缀

### 4. 网络请求被拦截

**检查步骤**：

1. 在微信开发者工具中打开 **调试器** → **Network** 面板
2. 尝试登录
3. 查看是否有请求发出
4. 如果请求被拦截，会显示错误信息

**常见错误**：
- `request:fail` - 网络请求失败
- `不在以下 request 合法域名列表中` - 域名未配置
- `timeout` - 请求超时

### 5. SSL 证书问题

**问题**：如果服务器 SSL 证书配置不正确，小程序可能无法访问。

**检查步骤**：

1. 在浏览器中访问：`https://oa.ruoshui-edu.cn/api/health`
2. 检查浏览器是否显示证书错误
3. 如果证书有问题，需要修复 SSL 配置

### 6. CORS 配置问题

**检查步骤**：

1. 检查后端 `.env` 文件中的 `CORS_ORIGINS` 配置
2. 确保包含小程序域名（虽然小程序不受 CORS 限制，但后端应该允许）

### 7. 后端服务未运行

**检查步骤**：

1. 在服务器上测试 API：
   ```bash
   curl https://oa.ruoshui-edu.cn/api/health
   ```
2. 应该返回：`{"status":"healthy"}`
3. 如果返回错误，检查后端服务状态

## 调试步骤

### 步骤 1：查看控制台日志

1. 打开微信开发者工具
2. 点击 **调试器** → **Console**
3. 尝试登录
4. 查看日志输出：
   - `🔐 登录请求:` - 显示请求 URL 和参数
   - `🔐 登录响应:` - 显示响应状态码和数据
   - `✅ 登录成功` 或 `❌ 登录失败` - 显示结果

### 步骤 2：查看网络请求

1. 打开 **调试器** → **Network**
2. 尝试登录
3. 找到 `/auth/login` 请求
4. 查看：
   - **Request URL** - 是否正确
   - **Status Code** - 响应状态码
   - **Response** - 响应内容
   - **Headers** - 请求头信息

### 步骤 3：测试 API 直接访问

在浏览器中测试登录接口：

```bash
curl -X POST https://oa.ruoshui-edu.cn/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"your_username","password":"your_password"}'
```

如果浏览器可以成功，说明后端正常，问题在小程序配置。

## 快速检查清单

- [ ] 微信公众平台已配置 `https://oa.ruoshui-edu.cn` 为合法域名
- [ ] `app.js` 中的 `apiBaseUrl` 配置正确
- [ ] 使用 HTTPS（不是 HTTP）
- [ ] 后端服务正常运行
- [ ] SSL 证书配置正确
- [ ] 开发环境已开启"不校验合法域名"（仅开发测试）
- [ ] 控制台没有域名相关错误

## 常见错误信息

### 错误 1：`request:fail 不在以下 request 合法域名列表中`

**原因**：域名未在微信公众平台配置

**解决**：按照上述步骤 1 配置合法域名

### 错误 2：`request:fail timeout`

**原因**：网络请求超时

**解决**：
- 检查网络连接
- 检查服务器是否正常运行
- 检查防火墙设置

### 错误 3：`request:fail ssl handshake error`

**原因**：SSL 证书问题

**解决**：检查服务器 SSL 证书配置

### 错误 4：`登录失败 (403)`

**原因**：可能是权限问题或 token 问题

**解决**：
- 检查用户名和密码是否正确
- 检查后端日志
- 清除小程序缓存后重试

## 如果还是不行

1. **查看详细日志**：
   - 微信开发者工具控制台
   - 后端日志（Python 项目管理器）

2. **对比 Mobile 前端**：
   - Mobile 前端可以登录，说明后端正常
   - 问题应该在小程序配置或微信限制

3. **联系支持**：
   - 提供控制台完整日志
   - 提供网络请求详情
   - 说明具体错误信息

