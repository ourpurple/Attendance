# 签到打卡系统流程图

## 系统整体架构流程

```mermaid
graph TB
    A[用户打开小程序] --> B{检查登录状态}
    B -->|未登录| C[跳转登录页]
    B -->|已登录| D[加载主页数据]
    
    D --> E[检查工作日状态]
    E -->|休息日/节假日| F[隐藏打卡区域<br/>显示休息提示]
    E -->|工作日| G[获取打卡策略]
    
    G --> H[检查今日打卡状态]
    H -->|未打卡| I[判断当前时间]
    H -->|已上班打卡| J[显示签退按钮]
    H -->|已完成打卡| K[显示完成状态]
    
    I -->|在打卡时间内| L[启用打卡按钮]
    I -->|不在打卡时间内| M[禁用打卡按钮]
    
    L --> N[用户点击上班打卡]
    M --> O[显示等待提示]
    
    N --> P[检查请假状态]
    P -->|全天请假| Q[提示无需打卡]
    P -->|上午请假| R[检查时间14:10前]
    P -->|正常| S[获取位置信息]
    
    R -->|超过14:10| Q
    R -->|未超过14:10| S
    
    S --> T[检查是否迟到]
    T -->|会迟到| U[显示迟到确认]
    T -->|正常| V[执行打卡]
    
    U -->|用户确认| V
    U -->|用户取消| W[取消打卡]
    
    V --> X[保存打卡记录]
    X --> Y[更新页面状态]
    Y --> J
    
    J --> Z[用户点击下班打卡]
    Z --> AA[检查请假状态]
    AA -->|下午请假| AB[提示无需签退]
    AA -->|正常| AC[获取位置信息]
    
    AC --> AD[检查是否早退]
    AD -->|会早退| AE[显示早退确认]
    AD -->|正常| AF[执行签退]
    
    AE -->|用户确认| AF
    AE -->|用户取消| AG[取消签退]
    
    AF --> AH[更新打卡记录]
    AH --> AI[计算工作时长]
    AI --> K
```

## 详细业务逻辑流程

### 1. 页面初始化流程

```mermaid
graph TD
    A[onShow事件] --> B[检查token]
    B -->|无token| C[跳转登录页]
    B -->|有token| D[验证token有效性]
    
    D -->|无效| C
    D -->|有效| E[获取用户信息]
    E --> F[检查权限]
    
    F --> G[检查审批权限]
    F --> H[检查出勤查看权限]
    F --> I[加载页面数据]
    
    I --> J[加载今日打卡状态]
    I --> K[加载最近考勤]
    I --> L[加载待审批数量]
    I --> M[加载打卡状态列表]
    I --> N[检查并设置打卡按钮]
```

### 2. 工作日检查流程

```mermaid
graph TD
    A[检查工作日状态] --> B[调用后端API]
    B --> C{API返回结果}
    C -->|成功| D[解析工作日状态]
    C -->|失败| E[本地判断工作日]
    
    D --> F{是否工作日}
    E --> F
    
    F -->|是工作日| G[获取打卡策略时间]
    F -->|非工作日| H[设置休息日状态]
    
    G --> I[判断当前时间段]
    I --> J[设置按钮状态和提示]
    
    H --> K[隐藏打卡区域]
    H --> L[显示休息提示]
```

### 3. 上班打卡详细流程

```mermaid
graph TD
    A[点击上班打卡] --> B[检查按钮状态]
    B -->|已禁用| C[提示已打卡]
    B -->|可用| D[检查工作日]
    
    D -->|非工作日| E[提示无需打卡]
    D -->|工作日| F[检查请假状态]
    
    F --> G{请假状态}
    G -->|全天请假| H[提示无需打卡]
    G -->|上午请假| I[检查当前时间]
    G -->|无请假| J[继续打卡流程]
    
    I --> K{时间检查}
    K -->|超过14:10| H
    K -->|未超过14:10| L[显示确认对话框]
    
    L --> M{用户选择}
    M -->|取消| N[结束流程]
    M -->|确认| J
    
    J --> O[检查迟到状态]
    O --> P{是否会迟到}
    P -->|会迟到| Q[显示迟到确认]
    P -->|正常| R[获取位置信息]
    
    Q --> S{用户选择}
    S -->|取消| N
    S -->|确认| R
    
    R --> T[调用GPS定位]
    T --> U{定位结果}
    U -->|成功| V[获取地址信息]
    U -->|失败| W[使用坐标信息]
    
    V --> X[选择打卡状态]
    W --> X
    
    X --> Y[提交打卡请求]
    Y --> Z[保存到数据库]
    Z --> AA[更新页面状态]
    AA --> AB[显示成功提示]
```

### 4. 下班打卡详细流程

```mermaid
graph TD
    A[点击下班打卡] --> B[检查按钮状态]
    B -->|已禁用| C[提示已打卡]
    B -->|可用| D[检查请假状态]
    
    D --> E{请假状态}
    E -->|下午请假| F[提示无需签退]
    E -->|无请假| G[检查工作日]
    
    G -->|非工作日| H[提示无需打卡]
    G -->|工作日| I[检查早退状态]
    
    I --> J{是否会早退}
    J -->|会早退| K[显示早退确认]
    J -->|正常| L[获取位置信息]
    
    K --> M{用户选择}
    M -->|取消| N[结束流程]
    M -->|确认| L
    
    L --> O[调用GPS定位]
    O --> P{定位结果}
    P -->|成功| Q[获取地址信息]
    P -->|失败| R[使用坐标信息]
    
    Q --> S[提交签退请求]
    R --> S
    
    S --> T[更新数据库记录]
    T --> U[计算工作时长]
    U --> V[更新页面状态]
    V --> W[显示成功提示]
```

### 5. 时间判断逻辑流程

```mermaid
graph TD
    A[获取当前时间] --> B[转换为分钟数]
    B --> C[获取打卡策略]
    
    C --> D[解析时间范围]
    D --> E[checkin_start_time]
    D --> F[checkin_end_time]
    D --> G[checkout_start_time]
    D --> H[checkout_end_time]
    
    E --> I[判断是否在签到时间]
    F --> I
    G --> J[判断是否在签退时间]
    H --> J
    
    I --> K{时间范围判断}
    K -->|在签到时间| L[启用签到按钮]
    K -->|不在签到时间| M[禁用签到按钮]
    
    J --> N{时间范围判断}
    N -->|在签退时间| O[启用签退按钮]
    N -->|不在签退时间| P[禁用签退按钮]
```

### 6. 请假状态检查流程

```mermaid
graph TD
    A[检查请假状态] --> B[调用请假API]
    B --> C[解析请假信息]
    
    C --> D{请假类型判断}
    D -->|全天请假| E[设置全天请假状态]
    D -->|上午请假| F[设置上午请假状态]
    D -->|下午请假| G[设置下午请假状态]
    D -->|无请假| H[设置正常状态]
    
    E --> I[禁用所有打卡]
    F --> J[允许14:10前签到]
    G --> K[允许上午签到]
    H --> L[正常打卡流程]
    
    J --> M{时间检查}
    M -->|未超过14:10| L
    M -->|超过14:10| I
```

## 数据库操作流程

### 打卡记录保存流程

```mermaid
graph TD
    A[接收打卡请求] --> B[验证用户身份]
    B --> C[检查今日记录]
    C --> D{是否存在记录}
    
    D -->|存在| E[更新现有记录]
    D -->|不存在| F[创建新记录]
    
    E --> G[更新打卡时间]
    E --> H[更新位置信息]
    E --> I[更新状态标记]
    
    F --> J[设置用户ID]
    F --> K[设置打卡时间]
    F --> L[设置位置信息]
    F --> M[设置状态标记]
    
    G --> N[保存到数据库]
    H --> N
    I --> N
    J --> N
    K --> N
    L --> N
    M --> N
    
    N --> O[返回成功响应]
```

## 异常处理流程

```mermaid
graph TD
    A[操作执行] --> B{是否成功}
    B -->|成功| C[返回正常结果]
    B -->|失败| D[捕获异常]
    
    D --> E{异常类型}
    E -->|网络异常| F[显示网络错误提示]
    E -->|权限异常| G[显示权限错误提示]
    E -->|数据异常| H[显示数据错误提示]
    E -->|系统异常| I[显示系统错误提示]
    
    F --> J[记录错误日志]
    G --> J
    H --> J
    I --> J
    
    J --> K[提供重试选项]
    K --> L[用户选择重试]
    L -->|是| A
    L -->|否| M[结束流程]
```

## 关键业务规则

1. **时间规则**
   - 上班打卡时间：08:00-11:30（可配置）
   - 下班打卡时间：17:20-20:00（可配置）
   - 上午请假14:10前可签到
   - 迟到阈值：可配置分钟数

2. **状态规则**
   - 正常签到、市区办事、出差三种状态
   - 迟到、早退自动标记
   - 请假状态优先级最高

3. **权限规则**
   - 必须登录才能打卡
   - 工作日才能打卡
   - 请假状态限制打卡

4. **数据规则**
   - 每天只能有一次上班打卡
   - 必须先上班打卡才能下班打卡
   - 位置信息可选，失败不影响打卡